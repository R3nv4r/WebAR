<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebAR Video con Audio</title>
    <!-- Librerías de A-Frame y MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Tu CSS existente -->
    <link rel="stylesheet" href="./css/detonadores.css">

    <style>
      /* Estilos para el botón de Play/Pause */
      #play-button {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000; /* Asegura que esté por encima del canvas de AR */
        padding: 12px 24px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: 2px solid white;
        border-radius: 30px;
        font-family: sans-serif;
        font-size: 16px;
        cursor: pointer;
        display: none; /* Oculto por defecto hasta encontrar el target */
        transition: background 0.3s;
      }
      #play-button:active {
        background-color: rgba(255, 255, 255, 0.3);
      }
    </style>

    <script>
      AFRAME.registerComponent('videohandler', {
        init: function () {
          this.toggle = false;
          this.vid = document.querySelector("#video-asset");
          this.btn = document.querySelector("#play-button");
          
          // Aseguramos que el video esté pausado al inicio
          this.vid.pause();

          // Lógica del botón de Play/Pause
          this.btn.addEventListener('click', () => {
            if (this.vid.paused) {
              this.vid.play();
            } else {
              this.vid.pause();
            }
          });

          // Escuchar eventos del video para cambiar el texto del botón automáticamente
          this.vid.addEventListener('play', () => {
            this.btn.innerText = "⏸";
          });
          this.vid.addEventListener('pause', () => {
            this.btn.innerText = "▶";
          });
        },
        tick: function () {
          if (this.el.object3D.visible == true) {
            if (!this.toggle) {
              this.toggle = true;
              // Intentar reproducir automáticamente al encontrar
              // NOTA: Si el navegador bloquea el audio, el video quedará pausado
              // y el usuario podrá usar el botón para iniciar.
              this.vid.play().catch(e => {
                 console.log("Autoplay bloqueado, esperando interacción del usuario.");
              });
              
              // Mostrar el botón de control
              this.btn.style.display = "block";
            }
          } else {
            if (this.toggle) {
              this.toggle = false;
              // Pausar video y ocultar botón al perder el target
              this.vid.pause();
              this.btn.style.display = "none";
            }
          }
        }
      });
    </script>
  </head>
  <body>

    <!-- Pantalla de carga original (visible por defecto, loadingScreen.js la ocultará) -->
    <div id="loading-screen">
       <img src="./assets/carga.gif" alt="Cargando...">
    </div>

    <!-- Nuevo Botón de Control -->
    <button id="play-button">▶</button>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <!-- Video Asset -->
        <!-- Recuerda cambiar 'video_ejemplo.mp4' por tu archivo real -->
        <video id="video-asset" 
               src="./assets/themarvels.mp4" 
               preload="auto" 
               loop="true" 
               crossorigin="anonymous" 
               playsinline 
               webkit-playsinline>
        </video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Target con el componente videohandler -->
      <a-entity mindar-image-target="targetIndex: 0" videohandler>
        <a-video src="#video-asset" width="1" height="0.552" position="0 0 0" rotation="0 0 0"></a-video>
      </a-entity>
    </a-scene>

    <!-- Script de carga original -->
    <script src="./js/loadingScreen.js"></script>
  </body>
</html>